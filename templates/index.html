<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->

    <link rel="stylesheet" href="https://bootswatch.com/4/flatly/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/index.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
      <title>Home</title>
</head>
<body>
<div class="header">
  <a style="background: white;">Welcome {{session.name}}</a>
	<a class="logo" style="color: blue; text-decoration: none; margin-left: 25%; background: white;">Road Accident Prediction</a>
  <div class="header-right">
    <a href="{{ url_for('home') }}">Home</a>
    <a href="{{ url_for('map') }}">Map</a>
    <a href="{{ url_for('visualization') }}">Visualization</a>
	<a href="{{ url_for('logout') }}"> Logout</a>
  </div>
</div>


<div class="container">

	<div class="row" style="margin-top: 30px;">
		<div class="col-8">
	      	<div class="form-group">
			 <div class="row">
			    <div class="col-6">
					<label for="Did_Police_Officer_Attend">Latitude</label>
			    <input type="text" class="form-control" name="lat" value="" id="lat">
				</div>
				<div class="col-6">
					<label for="Did_Police_Officer_Attend">Longitude</label>
			    <input type="text" class="form-control" name="lon" value="" id="lon">
				</div>
			</div>
			</div>

			<div class="form-group">
				<div class="row">
					<div class="col-6">
						<label for="Day_of_Week">Day of Week</label>

			      <select class="form-control" id="day">
		       		<option value="1">1 : Sunday</option>
			        <option value="2">2 : Monday</option>
			        <option value="3">3 : Tuesday</option>
			        <option value="4">4 : Wednesday</option>
			        <option value="5">5 : Thursday</option>
			        <option value="6">6 : Friday</option>
			        <option value="7">7 : Saturday</option>
			      </select>
					</div>
					<div class="col-6">
						<label for="Weather_Conditions">Weather Conditions</label>
			        <select class="form-control" id="weather" name="Weather_Conditions">
		       		<option value="1">1 : Fine no high winds</option>
			        <option value="2">2 : Raining no high winds</option>
			        <option value="3">3 : Snowing no high winds</option>
			        <option value="4">4 : Fine + high winds</option>
			        <option value="5">5 : Raining + high winds</option>
			        <option value="6">6 : Snowing + high winds</option>
			        <option value="7">7 : Fog or mist</option>
			      </select>
					</div>
				</div>
			</div>

			<div class="form-group">
				<div class="row">
					<div class="col-6">
						<label for="Light_Conditions">Light Conditions</label>
			    <select class="form-control" name="Light_Conditions" id="light" >
		       		<option value="1">1 : Daylight</option>
			        <option value="4">4 : Darkness - lights lit</option>
			        <option value="5">5 : Darkness - lights unlit</option>
			        <option value="6">6 : Darkness - no lighting</option>
			      </select>
					</div>
					<div class="col-6">
						<label for="Road_Surface_Conditions">Road Surface Conditions</label>

			    <select class="form-control" name="Road_Surface_Conditions" id="roadsc">
		       		<option value="1">1 : Dry</option>
			        <option value="2">2 : Wet or damp</option>
			        <option value="3">3 : Snow</option>
			        <option value="4">4 : Frost or Ice</option>
			        <option value="5">5 : Flood</option>
			        <option value="7">7 : Mud</option>
			    </select>
					</div>
				</div>
			</div>

	      	<div class="form-group">
				<div class="row">
					<div class="col-6">
						<label for="Age_of_Driver">Age of Driver</label>
			    		<input type="text" class="form-control" name="Age_of_Driver" value="{{ age_of_driver }}" id="age_of_driver">
					</div>
					<div class="col-6">
						<label for="Vehicle_Type">Vehicle Type</label>
						<input type="text" class="form-control" name="Weather_Conditions" value="{{ vehicle_type }}" id="vehicle_type">
					</div>
				</div>
			</div>

			<div class="form-group">
				<div class="row">
					<div class="col-6">
						<label for="Age_of_Vehicle">Age of Vehicle</label>
			    		<input type="text" class="form-control" name="Age_of_Vehicle" value="{{ age_of_vehicle }}" id="age_of_vehicle">
					</div>
					<div class="col-6">
						<label for="Engine_Capacity_CC">Engine Capacity in CC</label>
			    		<input type="text" class="form-control" name="Engine_Capacity_CC" value="{{ engine_capacity_in_cc }}" id="engine_cc">
					</div>
				</div>
			</div>

			<div class="form-group">
				<div class="row">
					<div class="col-6">
						<label for="gender">Gender</label>
						<input type="text" class="form-control" name="Road_Surface_Conditions" value="{{ gender }}" id="gender">
					</div>
					<div class="col-6">
						<label for="Speed_limit">Speed Limit</label>
			    		<input type="text" class="form-control" type="text" name="Speed_limit" value="30" id="speedl">
					</div>
				</div>
			</div>



			<div class="form-group">
				<label for="Did_Police_Officer_Attend">Number of Police Officers Present at the Scene</label>
				<input type="text" class="form-control" name="Did_Police_Officer_Attend" value="1" id="Did_Police_Officer_Attend">
			</div>


		</div>
		<div class="col-4 jumbotron text-center" style="position: fixed; right: 0">
		    <h3 style="text-align: center;"><u>Accident Severity</u></h3>
		    <div style="font-size:150%;text-align:center; color: red;" id="result"></div>
			<hr>
			<div>
				<button id = "getIt" class="btn btn-primary btn-block" onclick = "getLocation() ">Get Co-ordinates</button>
			</div>
			<div style="margin-top: 20px;">
				<button type="button" class="btn btn-success btn-block" id="submitBtn">Predict</button>
			</div>
		</div>
	</div>


</div>

	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <script>


function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition);
  } else {
    x.innerHTML = "Geolocation is not supported by this browser.";
  }


async function showPosition(position) {
	    var i=position.coords.latitude;
    	var j=position.coords.longitude;
    	var apiKey = null;
    	await fetch('/get_message')
			.then(response => response.json())
			.then(data => {
				apiKey = data.message;
				//console.log(apiKey);
			})
			.catch(error => {
				console.error('Error fetching apiKey:', error);
			});

    	document.getElementById("lat").value=i;
    	document.getElementById("lon").value=j;

        $.ajax({url: "https://api.openweathermap.org/data/2.5/weather?lat="+i+"&lon="+j+"&APPID="+apiKey,
        	success: function(res){
        		if(res.weather[0].main === "mist")
        		document.getElementById("weather").value=7;
        		else if(res.weather[0].main === "clear")
        		{
        			document.getElementById("weather").value=1;
        			document.getElementById("roadsc").value=1;
        		}
        		else if(res.weather[0].main === "Rain")
        			{
        				document.getElementById("weather").value=2;
        				document.getElementById("roadsc").value=2;
        			}
        		else if(res.weather[0].main === "Snow")
        		{
        			document.getElementById("weather").value=3;
        			document.getElementById("roadsc").value=3;
        		}
        		else if(res.weather[0].main === "Clouds")
        		{
        			document.getElementById("weather").value=4;
        			document.getElementById("roadsc").value=7;
        		}

        		  var d = new Date();
  				  var n = d.getHours();
  				  if(n>=19 || n<=6)
        		  document.getElementById("light").value=4;
        		  else if(n>6 || n<18)
        		  	document.getElementById("light").value=1;

        		  var d = d.getDay();
        		  document.getElementById("day").value=d+1;

        }});
    }
    }

	    document.addEventListener('DOMContentLoaded', function() {
	        document.getElementById('submitBtn').addEventListener('click', function(e) {
	            e.preventDefault();
	            $('#result').html('Loading...');

	            $.post(
	                '/ip',
	                {
	                    Did_Police_Officer_Attend: $('#Did_Police_Officer_Attend').val(),
	                    age_of_driver: Math.log(parseInt($('#age_of_driver').val())),
	                    vehicle_type: function() {
	                    				var vehicleType = $('#vehicle_type').val();
	                    				if (vehicleType === "Pedal cycle") {
	                    					return "1";
	                    				} else if (vehicleType === "Motorcycle 50cc and under") {
	                    					return "2";
	                    				} else if (vehicleType === "Motorcycle 125cc and under") {
	                    					return "3";
	                    				} else if (vehicleType === "Motorcycle over 125cc and up to 500cc") {
	                    					return "4";
	                    				} else if (vehicleType === "Motorcycle over 500cc") {
	                    					return "5";
	                    				} else if (vehicleType === "Taxi/Private hire car") {
	                    					return "8";
	                    				} else if (vehicleType === "Car") {
	                    					return "9";
	                    				} else if (vehicleType === "Minibus (8 - 16 passenger seats)") {
	                    					return "10";
	                    				} else if (vehicleType === "Bus or coach (17 or more pass seats)") {
	                    					return "11";
	                    				} else if (vehicleType === "Tram") {
	                    					return "18";
	                    				} else if (vehicleType === "Truck(Goods)") {
	                    					return "20";
	                    				} else if (vehicleType === "Electric motorcycle") {
	                    					return "23";
	                    				}
	                    			}(),
	                    age_of_vehicle: Math.log(parseInt($('#age_of_vehicle').val())),
	                    engine_cc: $('#engine_cc').val(),
	                    day: $('#day').val()[0],
	                    weather: $('#weather').val()[0],
	                    light: $('#light').val()[0],
	                    roadsc: $('#roadsc').val()[0],
	                    gender: function() {
									var genderValue = $('#gender').val();
									if (genderValue === "Male") {
										return "1";
									} else if (genderValue === "Female") {
										return "2";
									} else if (genderValue === "Unknown") {
										return "3";
									}
								}(),
	                    speedl: $('#speedl').val()
	                },
	                function(data) {
	                	var speedValue = parseFloat($('#speedl').val());
	                	var weatherValue = parseFloat($('#weather').val());
	                	var roadscValue = parseFloat($('#roadsc').val());
						if ((speedValue >= 100) || (speedValue >=80 && (weatherValue == 5 || weatherValue == 6)) || (speedValue >= 80 && (roadscValue == 3 || roadscValue == 4 || roadscValue == 5))) {
							data = '1.0';
							$.post(
                                '/sms',
                                {
                                    message: "Possibility of Severe Accident\n"
                                    + "\nLocation : " + "https://www.google.com/maps/@" + document.getElementById("lat").value + "," + document.getElementById("lon").value + ",21z?entry=ttu"
                                    + "\nLatitude : " + document.getElementById("lat").value
                                    + "\nLongitude : " + document.getElementById("lon").value
                                    + "\nWeather condition is " + $('#weather option:selected').text()
                                    + "\nLight condition is " + $('#light option:selected').text()
                                    + "\nRoad surface condition is " + $('#roadsc option:selected').text()
                                },
                                function(response) {
                                    alert(response);
                                }
                            );
						}
	                    if (data == 1.0) {
							$('#result').html(data + " : Possibility of Fatal Accident!");
						} else if ( data == 2.0) {
							$('#result').html(data + " : Possibility of Serious Accident!");
						} else if (data == 3.0) {
							$('#result').html(data + " : Possibility of Slite Accident!");
						}
	                    //console.log(data);
	                }
	            );
	        });
	    });
	</script>

  <div>
<footer class="footer">Copyright &copy; Prithviraj (M22AI603)</footer>
</div>
</body>
</html>
